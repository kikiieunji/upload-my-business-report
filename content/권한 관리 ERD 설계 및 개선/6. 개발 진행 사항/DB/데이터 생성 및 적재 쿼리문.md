
-- 1. 권한 정의(Permission)

CREATE TABLE permission (

id BIGINT AUTO_INCREMENT PRIMARY KEY,

key_name VARCHAR(255) NOT NULL UNIQUE COMMENT '권한 키(예 : ACCIDENT_READ)',

description VARCHAR(255) COMMENT '권한 설명',

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '생성일'

);

  

-- 2. 역할(Role)

CREATE TABLE role (

id BIGINT AUTO_INCREMENT PRIMARY KEY,

code VARCHAR(255) NOT NULL UNIQUE COMMENT '역할 코드(예 : ACCIDENT_EDITOR)',

name VARCHAR(255) NOT NULL COMMENT '역할 이름(예 : 사고 편집자, 사고 조회자)',

description VARCHAR(255) COMMENT '설명',

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '생성일',

updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정일'

);

  

-- 3. 역할-권한 매핑(Role-Permission Mapping)

  

drop table role_permission;

  

CREATE TABLE role_permission (

id BIGINT AUTO_INCREMENT PRIMARY KEY,

role_id BIGINT NOT NULL COMMENT '역할 ID',

permission_key VARCHAR(255) NOT NULL COMMENT '권한 키(예: ACCIDENT_READ)',

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '생성일',

FOREIGN KEY (role_id) REFERENCES role (id),

FOREIGN KEY (permission_key) REFERENCES permission (key_name)

);

  

-- 4. 사용자 역할 매핑(UDP-Role)

CREATE TABLE udp_role (

id BIGINT AUTO_INCREMENT PRIMARY KEY,

udp_id BIGINT NOT NULL COMMENT 'user_department_position ID',

role_id BIGINT NOT NULL,

FOREIGN KEY (role_id) REFERENCES role (id),

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '생성일',

updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정일'

);

  

-- 5. 사용자 범위 설정 (User_Scope)

CREATE TABLE user_scope (

id BIGINT AUTO_INCREMENT PRIMARY KEY,

udp_id BIGINT NOT NULL,

company_job_type_id BIGINT,

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '생성일'

);

  

----------------------------------------------------------------------------- 데이터 이관 및 적재

-- 1. 권한 정의

insert into

permission (

key_name,

description,

created_at

)

VALUES (

'ACCIDENT_READ',

'사고 조회 권한',

NOW()

),

(

'ACCIDENT_WRITE',

'사고 편집 권한',

NOW()

);

  

-- 2. 사용자 범위 데이터 이관

TRUNCATE TABLE user_scope;

  

INSERT INTO

user_scope (

udp_id,

company_job_type_id,

created_at

)

SELECT id, company_job_type_id, NOW()

FROM user_department_position

WHERE

company_job_type_id IS NOT NULL;

  

-- 3. role 데이터 생성

INSERT INTO

role (

code,

name,

description,

created_at,

updated_at

)

VALUES (

'ACCIDENT_EDITOR',

'사고 관리자',

'사고 조회/편집 권한을 가진 사람',

NOW(),

NOW()

),

(

'ACCIDENT_VIEWER',

'사고 조회자',

'사고 조회 권한만 가진 사람',

NOW(),

NOW()

);

  

-- 4. role_permission 데이터 생성 (역할 권한 매핑) - Key 기반 적재

-- 사고 관리자 (EDITOR) -> READ + WRITE 권한 부여

INSERT INTO

role_permission (

role_id,

permission_key,

created_at

)

SELECT r.id, p.key_name, NOW()

FROM role r

JOIN permission p ON p.key_name IN (

'ACCIDENT_READ', 'ACCIDENT_WRITE'

)

WHERE

r.code = 'ACCIDENT_EDITOR';

  

-- 사고 조회자 (VIEWER) -> READ 권한만 부여

INSERT INTO

role_permission (

role_id,

permission_key,

created_at

)

SELECT r.id, p.key_name, NOW()

FROM role r

JOIN permission p ON p.key_name = 'ACCIDENT_READ'

WHERE

r.code = 'ACCIDENT_VIEWER';

  

-- udp_group_function 조회

SELECT *

FROM user_department_position

WHERE

id IN (

SELECT udp_id

FROM udp_group_function

WHERE

udp_id IS NOT NULL

);

  

-- udp_group_function 테이블에 매핑되어 있는 사용자들에게 역할 부여(ACCIDENT_EDITOR)

INSERT INTO

udp_role (udp_id, role_id, created_at)

SELECT DISTINCT

ugf.udp_id,

(

SELECT id

FROM role

WHERE

code = 'ACCIDENT_EDITOR'

), -- 이름을 ID로 변환

NOW()

FROM udp_group_function ugf

WHERE

NOT EXISTS (

SELECT 1

FROM udp_role ur

WHERE

ur.udp_id = ugf.udp_id

AND ur.role_id = (

SELECT id

FROM role

WHERE

code = 'ACCIDENT_EDITOR'

) -- 비교할 때도 ID로 변환

);

  

-- job_type이 임원진인 사람에게 ACCIDENT_EDITOR 부여

INSERT INTO

udp_role (udp_id, role_id, created_at)

SELECT DISTINCT

udp_pos.id, -- udp_id (user_department_position의 PK)

(

SELECT id

FROM role

WHERE

code = 'ACCIDENT_EDITOR'

),

NOW()

FROM

user_department_position udp_pos

JOIN position p ON udp_pos.position_id = p.id -- 직책 정보 확인을 위해 조인

WHERE

p.job_type = 'EXECUTIVE' -- 직책의 타입이 임원(EXECUTIVE)인 경우

-- 이미 권한이 있는 경우 중복 생성 방지

AND NOT EXISTS (

SELECT 1

FROM udp_role ur

WHERE

ur.udp_id = udp_pos.id

AND ur.role_id = (

SELECT id

FROM role

WHERE

code = 'ACCIDENT_EDITOR'

)

);

  

-- 교통안전부 소속이나 udp_group_function 속해 있지 않은 사람에게 ACCIDENT_VIEWER 부여 (실패 쿼리)

INSERT INTO

udp_role (udp_id, role_id, created_at)

SELECT udp_pos.id, (

SELECT id

FROM role

WHERE

code = 'ACCIDENT_VIEWER'

), NOW()

FROM

user_department_position udp_pos

JOIN department d ON udp_pos.department_id = d.id

WHERE

d.name = '교통안전부'

AND udp_pos.id NOT IN(

SELECT DISTINCT

udp_id

FROM udp_group_function

WHERE

udp_id IS NOT NULL

)

AND NOT EXISTS (

SELECT 1

FROM udp_role ur

WHERE

ur.udp_id = udp_pos.id

AND ur.role_id = (

SELECT id

FROM role

WHERE

code = 'ACCIDENT_VIEWER'

)

);


-- Approval_template 테이블에 role_id 컬럼 추가 및 role_id FK 부여

ALTER TABLE approval_template_authority ADD COLUMN role_id BIGINT;


ALTER TABLE approval_template_authority

ADD CONSTRAINT fk_ata_role FOREIGN KEY (role_id) REFERENCES role (id);